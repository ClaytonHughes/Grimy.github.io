<meta charset=UTF-8>
<title>zFarm</title>
<style>
body { background: #E6E6E6; color: #333; font-size: 1.1em }
* { box-sizing: border-box }
fieldset {
	padding: 20px; width: 40rem; border: 1px solid #04B; border-radius: 8px; background: #EEE;
	-webkit-box-shadow: 0 3px 5px rgba(0,0,0,.4); box-shadow: 0 3px 5px rgba(0,0,0,.4);
}
legend { font-size: 1.3rem }
legend, h1 { color: #04B }
label {
	display: block; margin: 1ex .25em;
	text-decoration: underline dotted; cursor: help;
}
input, select { width: 50%; margin: 0 }
form {
	width: 80%;
	margin: 0 auto;
	display: flex;
	flex-flow: row wrap;
	justify-content: space-between;
}
h1, button { display: block; width: 400px; margin: 30px auto }
button {
	padding: 0; cursor: pointer;
	-webkit-transition: background-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
	-o-transition: background-color ease-in-out .15s, box-shadow ease-in-out .15s;
	transition: background-color ease-in-out .15s, box-shadow ease-in-out .15s;
	background-color: #06F; color: #EEE; height: 2.2em; font-size: 1.4em;
	border: 1px solid rgba(0, 0, 0, .4); border-radius: 4px;
}
button:hover  { background-color: #05D }
button:active { background-color: #04B; -webkit-box-shadow: inset 0 3px 5px rgba(0,0,0,.4); box-shadow: inset 0 3px 5px rgba(0,0,0,.4) }
</style>

<h1>Where should I farm?</h1>

<p>Warning: this calculator assumes that your trimps are alive 100% of the time. If this is not the case, you’ll want to farm slightly lower than what it suggests.</p>

<form action='javascript://0'>
	<fieldset>

		<legend>Inputs</legend>

		<label title='Your minimum attack, in the stance you use for farming, without the Titimp buff'>
			<input type=text id=attack value=12Qi>
			Min ATK
		</label>

		<label title='Biome of the maps you create'>
			<select id=biome>
				<option value=gardens>Garden</option>
				<option value=mountain>Mountain</option>
				<option value=depths>Depths</option>
				<option value=forest>Forest</option>
				<option value=sea>Sea</option>
			</select>
			Biome
		</label>

		<label title='Total number of map imp-orts you have unlocked'>
			<input type=text id=imports value=5 pattern='[0-5]'>
			Map imp-orts
		</label>

		<label title='Check if you have unlocked the Titimp imp-ort'>
			<input type=checkbox checked id=titimp>
			Unlocked titimp?
		</label>

		<label title='Bonus enemy health in maps, in percent'>
			<input type=text checked id=challenge>
			Challenge +health%
		</label>

		<label title='Level of your Agility perk (max 20)'>
			<input type=text id=agility value=20 pattern='1?\d|20'>
			Agility
		</label>

		<label title='Your max attack, divided by your min attack (usually 1.2, but can vary due to challenges)'>
			<input type=text id=range value='1.2'>
			Attack range (max/min)
		</label>

		<label title='Critical hit chance, as displayed in the damage breakdown (max 80)'>
			<input type=text id=crit_chance value=50 pattern='[0-9.]+'>
			Crit chance
		</label>

		<label title='Bonus critical damage, as displayed in the damage breakdown'>
			<input type=text id=crit_damage value=400>
			Crit damage%
		</label>

		<label title='Maximum size of the maps you create'>
			<input type=text id=size value=30 pattern='\d\d'>
			Map size
		</label>

		<label title='Maximum difficulty of the maps you create'>
			<input type=text id=difficulty value=84 pattern='\d+'>
			Map difficulty%
		</label>

		<label title='Level of your Overkill perk (max 30)'>
			<input type=text id=overkill value=0 pattern='[12]?\d|30'>
			Overkill
		</label>

		<label title='Check if you have unlocked the Hyperspeed mastery'>
			<input type=checkbox id=hyperspeed>
			Hyperspeed?
		</label>

		<button onclick='display(stats(parse_inputs()))'>Recalculate</button>
	</fieldset>

	<fieldset>
		<legend>Results</legend>
		<p style='font-size: 1.1em'><b id=result></b>. <span id=comment></span>
		<p>The highest zone where you one-shot everything is <b id=one-shot></b>.
		<p id=details>
		<p>Note: the displayed loot values don’t account for special imps, looting perks and staffs.
		As such, your actual loot will be much higher. However, these factors affect all maps in the
		same way, and don’t affect the choice of map.
	</fieldset>
</form>

<script src=zfarm.js></script>
<script>
const suffixes = [
	'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc',
	'Ud', 'Dd', 'Td', 'Qad', 'Qid', 'Sxd', 'Spd', 'Od', 'Nd', 'V',
	'Uv', 'Dv', 'Tv', 'Qav', 'Qiv', 'Sxv', 'Spv', 'Ov', 'Nv', 'Tt',
];

function $(str) { return document.querySelector(str); }

function parse_suffixes(str) {
	for (var i = suffixes.length; i > 0; --i)
		str = str.replace(new RegExp(suffixes[i - 1], 'i'), `E${3 * i}`)
	return parseFloat(str);
}

function parse_inputs() {
	return {
		agility: 10 * Math.pow(.95, $('#agility').value) - $('#hyperspeed').checked,
		atk: parse_suffixes($('#attack').value.toLowerCase()),
		biome: biomes.all.concat(biomes[$('#biome').value]),
		cc: $('#crit_chance').value / 100 * max_rand,
		cd: 1 + $('#crit_damage').value / 100,
		difficulty: $('#difficulty').value / 100 * (1 + $('#challenge').value / 100),
		import_chance: $('#imports').value * .03 * max_rand,
		overkill: $('#overkill').value * .005,
		range: ($('#range').value - 1) / max_rand,
		size: $('#size').value | 0,
		titimp: $('#titimp').checked,
	}
}

function prettify(number) {
	if (number < 10000)
		return Math.round(number);
	let unit = -1;
	while (number > 1000)
		number /= 1000, ++unit;
	return number.toFixed((number < 10) + (number < 100)) + suffixes[unit];
}

function display(infos) {
	$('#one-shot').textContent = `z${infos[0].zone}`;

	$('#details').innerHTML = '';
	for (info of infos) {
		var p = document.createElement('p');
		var cps = info.cells * 10 / max_ticks;
		info.value = cps * info.loot;
		p.textContent = `z${info.zone}: ${prettify(info.loot)} loot at ${cps.toFixed(3)} cells/s`;
		// if (info.value !== infos[0].value) {
			// var delta = percentage(info.value / infos[0].value);
			// p.textContent += ` = ${Math.abs(delta)}% ${delta < 0 ? 'less' : 'more'} loot/s than on z${infos[0].zone}`;
		// }
		// p.textContent += '.';
		p.textContent += ` = ${prettify(info.loot * cps)} loot/s.`;
		$('#details').appendChild(p);
	}

	infos.sort((a, b) => b.value - a.value);

	var best = infos[0].zone;
	var second = infos[1].zone;
	var ratio = infos[0].value / infos[1].value;
	var max_loot = $('#biome').value == 'gardens' ? 185 : 160;
	var loot_diff = Math.ceil(max_loot * (1 - 1 / ratio));
	var adverbs = ["", "", " probably", " probably", " probably", " probably",
		" probably", "", "", "", " really", " really", " definitely"]

	$('#result').textContent = `You should ${adverbs[Math.min(loot_diff, 12)]} farm on z${best}`;
	if (loot_diff <= 1) {
		$('#result').textContent += ` or z${second}`;
		$('#comment').textContent = `They’re equally efficient.`;
	} else {
		$('#comment').textContent = loot_diff <= 6 ?
			`But a z${second} map with ${loot_diff}% higher loot is better.` :
			`It’s ${percentage(ratio)}% more efficient than z${second}.`;
	}
}

display(stats(parse_inputs()));
</script>
