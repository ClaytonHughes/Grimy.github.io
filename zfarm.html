<meta charset=UTF-8>
<title>zFarm</title>
<link rel=stylesheet href='grim.css'>
<style>
body { font-size: 1.1em }
label { display: block; margin: 1ex .25em }
input, select, textarea { width: 50%; margin: 0 }
fieldset { flex: 0 1 40em }
</style>

<h1>zFarm</h1>

<p>&nbsp;Warning: this calculator assumes that your trimps are alive 100% of the time. If this is not the case, you’ll want to farm slightly lower than what it suggests.</p>

<form class=flexbox action='javascript://0'>
	<fieldset>
		<legend>Inputs</legend>

		<label title='Export your Trimps save and paste it here'>
			<textarea id=save onchange='read_save()'></textarea>
			Import save
		</label>

		<label title='Biome of the maps you create'>
			<select id=biome>
				<option value=gardens>Garden</option>
				<option value=mountain>Mountain</option>
				<option value=depths>Depths</option>
				<option value=forest>Forest</option>
				<option value=sea>Sea</option>
			</select>
			Biome
		</label>

		<label title='Your minimum attack, in the stance you use for farming, without the Titimp buff'>
			<input type=text id=attack value=12Qi>
			Min ATK
		</label>

		<label title='Total number of map imp-orts you have unlocked'>
			<input type=text id=imports value=5 pattern='[0-5]'>
			Map imp-orts
		</label>

		<label title='Check if you have unlocked the Titimp imp-ort'>
			<input type=checkbox checked id=titimp>
			Unlocked titimp?
		</label>

		<label title='Bonus enemy health in maps, in percent'>
			<input type=text checked id=challenge>
			Challenge +health%
		</label>

		<label title='Level of your Agility perk (max 20)'>
			<input type=text id=agility value=20 pattern='1?\d|20'>
			Agility
		</label>

		<label title='Your max attack, divided by your min attack (usually 1.2, but can vary due to challenges)'>
			<input type=text id=range value='1.2'>
			Attack range (max/min)
		</label>

		<label title='Critical hit chance, as displayed in the damage breakdown (max 80)'>
			<input type=text id=cc value=50 pattern='[0-9.]+'>
			Crit chance
		</label>

		<label title='Bonus critical damage, as displayed in the damage breakdown'>
			<input type=text id=cd value=400>
			Crit damage%
		</label>

		<label title='Maximum size of the maps you create'>
			<input type=text id=size value=30 pattern='\d\d'>
			Map size
		</label>

		<label title='Maximum difficulty of the maps you create'>
			<input type=text id=difficulty value=84 pattern='\d+'>
			Map difficulty%
		</label>

		<label title='Level of your Overkill perk (max 30)'>
			<input type=text id=overkill value=0 pattern='[12]?\d|30'>
			Overkill
		</label>

		<label title='Check if you have unlocked the Hyperspeed mastery'>
			<input type=checkbox id=hyperspeed>
			Hyperspeed?
		</label>

		<button onclick='display(stats(parse_inputs()))'>Recalculate</button>
	</fieldset>

	<fieldset>
		<legend>Results</legend>
		<p style='font-size: 1.1em'><b id=result></b>. <span id=comment></span>
		<p>The highest zone where you one-shot everything is <b id=one-shot></b>.
		<p id=details>
		<p>Note: the displayed loot values don’t account for special imps, looting perks and staffs.
		As such, your actual loot will be much higher. However, these factors affect all maps in the
		same way, and don’t affect the choice of map.
	</fieldset>
</form>

<nav class=flexbox>
	<a href='https://github.com/Grimy/Grimy.github.io/issues/new'>Report a bug</a>
	<a href='https://github.com/Grimy/Grimy.github.io/blob/master/zfarm.js'>View the source</a>
	<a href='https://github.com/Grimy'>By Grimy</a>
</nav>

<script src=lz-string.js></script>
<script src=trimps.js></script>
<script src=zfarm.js></script>
<script>

function read_save() {
	let game = JSON.parse(LZString.decompressFromBase64($('#save').value));
	if (!game)
		return;

	let imps = 0;
	for (let imp of ['Chronoimp', 'Jestimp', 'Titimp', 'Flutimp', 'Goblimp'])
		imps += game.unlocks.imps[imp];
	let crits = game.portal.Relentlessness.level;
	let challenge = game.global.challengeActive;
	let attack = game.global.soldierCurrentAttack;
	let maxFluct = 1.2;
	let minFluct = 0.8 + 0.02 * game.portal.Range.level;
	let enemyHealth = 1;

	attack *= 1 + 0.02 * game.global.antiStacks * game.portal.Anticipation.level;
	attack *= 1 + 0.01 * game.global.achievementBonus;
	attack *= 1 + 0.2 * game.global.roboTrimpLevel;
	attack *= 1 + game.goldenUpgrades.Battle.currentBonus;

	if (challenge == "Daily") {
		let daily = (mod) => game.global.dailyChallenge[mod] ? game.global.dailyChallenge[mod].strength : 0;
		enemyHealth *= 1 + 0.2 * daily('badHealth');
		enemyHealth *= 1 + 0.3 * daily('badMapHealth');
		minFluct -= 0.09 + 0.01 * daily('minDamage');
		maxFluct += daily('maxDamage');
		attack *= 1 - 0.09 * daily('weakness');
		attack *= 1 - 0.02 * daily('oddTrimpNerf');
		attack *= 1 + 0.2 * daily('evenTrimpBuff');
	} else if (challenge == "Toxicity" || challenge == "Balance" || challenge == "Meditate") {
		enemyHealth = 2;
	} else if (challenge == "Lead" && (game.global.world % 2) == 1) {
		attack *= 1.5;
	} else if (challenge == "Discipline") {
		maxFluct = 1.995;
		minFluct = 0.005;
	}

	// TODO pass Max Atk instead of Range
	$('#agility').value = game.portal.Agility.level;
	$('#attack').value = prettify(attack * minFluct);
	$('#cc').value = 5 * crits + game.heirlooms.Shield.critChance.currentBonus;
	$('#cd').value = 100 + 30 * crits + game.heirlooms.Shield.critDamage.currentBonus;
	$('#range').value = maxFluct / minFluct;
	$('#overkill').value = game.portal.Overkill.level;
	$('#titimp').checked = game.unlocks.imps.Titimp;
	$('#challenge').value = Math.round(100 * (enemyHealth - 1));
	$('#hyperspeed').checked = game.talents.hyperspeed.purchased;
}

const parse_inputs = () => ({
	agility: 10 * Math.pow(.95, $('#agility').value) - $('#hyperspeed').checked,
	atk: parse_suffixes($('#attack').value.toLowerCase()),
	biome: biomes.all.concat(biomes[$('#biome').value]),
	cc: $('#cc').value / 100 * max_rand,
	cd: 1 + $('#cd').value / 100,
	difficulty: $('#difficulty').value / 100 * (1 + $('#challenge').value / 100),
	import_chance: $('#imports').value * .03 * max_rand,
	overkill: $('#overkill').value * .005,
	range: ($('#range').value - 1) / max_rand,
	size: $('#size').value | 0,
	titimp: $('#titimp').checked,
});

function display(infos) {
	$('#one-shot').textContent = `z${infos[0].zone}`;

	$('#details').innerHTML = '';
	for (info of infos) {
		var p = document.createElement('p');
		var cps = info.cells * 10 / max_ticks;
		info.value = cps * info.loot;
		p.textContent = `z${info.zone}: ${prettify(info.loot)} loot at ${cps.toFixed(3)} cells/s`;
		// if (info.value !== infos[0].value) {
			// var delta = percentage(info.value / infos[0].value);
			// p.textContent += ` = ${Math.abs(delta)}% ${delta < 0 ? 'less' : 'more'} loot/s than on z${infos[0].zone}`;
		// }
		// p.textContent += '.';
		p.textContent += ` = ${prettify(info.loot * cps)} loot/s.`;
		$('#details').appendChild(p);
	}

	infos.sort((a, b) => b.value - a.value);

	var best = infos[0].zone;
	var second = infos[1].zone;
	var ratio = infos[0].value / infos[1].value;
	var max_loot = $('#biome').value == 'gardens' ? 185 : 160;
	var loot_diff = Math.ceil(max_loot * (1 - 1 / ratio));
	var adverbs = ["", "", " probably", " probably", " probably", " probably",
		" probably", "", "", "", " really", " really", " definitely"]

	$('#result').textContent = `You should ${adverbs[Math.min(loot_diff, 12)]} farm on z${best}`;
	if (loot_diff <= 1) {
		$('#result').textContent += ` or z${second}`;
		$('#comment').textContent = `They’re equally efficient.`;
	} else {
		$('#comment').textContent = loot_diff <= 6 ?
			`But a z${second} map with ${loot_diff}% higher loot is better.` :
			`It’s ${percentage(ratio)}% more efficient than z${second}.`;
	}
}

read_save();
display(stats(parse_inputs()));
</script>
