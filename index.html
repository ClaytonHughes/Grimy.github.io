<!DOCTYPE html>
<meta charset=utf-8>
<style>
	td {
		width: 50px;
		height: 50px;
		border: 1px solid black;
		font-size: 32px;
		text-align: center;
		background: white;
	}
	.target {
		cursor: pointer;
		background: lightgreen;
	}
	.selected {
		background: lightblue;
	}
</style>
<table><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><caption></caption></table>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script>
	// Game data
	// Each byte is life life life life owner piece piece piece
	// byte >> 4 is the actual life total
	// byte & 8 is 0 for P1, 8 for P2
	// byte & 7 is the piece type
	var ALICORN = 1, EARTH = 2, PEGASUS = 3, UNICORN = 4, FOAL = 5;
	var EMPTY = 0, TREE = 16, FOAL = 21;
	var ATTACK = [0, 2,  2, 1, 3, 1];
	var LIFE =   [0, 10, 5, 3, 2, 2];
	var SPEED =  [0, 2,  1, 3, 2, 2];
	var POWER =  [0, 1.5,  1, 0, 3, 0];

	var selected = Number.NaN;
	var powering = Number.NaN;
	var power = 0;
	var fleeing = 0;
	var turn = 0;

	var board = new Uint8Array(49);
	for (var i = 0; i < 14; i++) {
		piece = [4, 3, 2, 1, 2, 3, 4][i] || 5;
		piece += LIFE[piece] - 1 << 4;
		board[i] = piece | 8;
		board[48 - i] = piece;
	}

	// Game rules
	function pick(i) {
		piece = board[i];
		if (fleeing) {
			board[i] = fleeing;
		} else if (selected != selected || power == 3) {
			power = power == 3 ? 2 : 0;
			return powering = selected = i;
		} else if (~~power == 1) { // Summoning
			board[i] = power == 1 ? TREE : FOAL | turn;
		} else { // Normal movement
			board[i] = board[selected];
			board[selected] = 0;
			powering = i;
		}
		if (piece != EMPTY) { // Fight!
			if (piece == TREE)
				board[i] = (board[i] & 15) | (LIFE[board[i] & 7] << 4)
			piece -= ATTACK[board[i] & 7] << 4;
		}
		fleeing = piece > 0 && power != 3 && piece;
		power = fleeing || power ? 0 : POWER[board[powering] & 7];
		turn = fleeing ? fleeing & 8 : ((board[powering] & 8) ^ (power ? 0 : 8));
		selected = fleeing ? i : power ? powering : Number.NaN;
	}

	function canMove(from, to) {
		// Filter out invalid targets
		if (~~power == 1 && board[to] != EMPTY)
			return false;
		if (((board[to] & 7) && (board[to] & 8) == turn) ^ power == 3)
			return from != from;
		var dx = to % 7 - from % 7;
		var dy = ~~(to / 7) - ~~(from / 7);
		var dist = Math.abs(dx) + Math.abs(dy);
		var speed = fleeing ? 1 : power || SPEED[board[from] & 7];

		return dist <= speed && dist && (speed == 3 || dist != 2 ||
			(dx && dy ? !board[from + dx] || !board[from + 7 * dy] : !board[from + to >> 1]));
	}

	// Style data
	$('tr').append($('<td></td><td></td><td></td><td></td><td></td><td></td><td></td>'));
	var tds = $('td');
	var colors = ['red', 'blue', 'green'];
	var texts = ['', 'A', 'E', 'P', 'U', 'F', '', '', ' ', 'T'];

	function display(i) {
		var piece = board[i];
		$(this).toggleClass('target', canMove(selected, i));
		$(this).toggleClass('selected', selected == i);
		if (piece & 7) {
			var damage = LIFE[piece & 7] - 1 - (piece >> 4);
			this.textContent = texts[piece & 7] + (damage || '');
			this.style.color = colors[(piece & 8) >> 3];
		} else {
			this.textContent = texts[(piece >> 4) | 8];
			this.style.color = colors[2];
		}
		$('caption').text('Player ' + (turn ? 2 : 1) + ', ' + (fleeing ? 'flee!' : power ? 'use your power!' : 'make a move!'))
	}
	
	$('table').on('click', 'td.target', function() {
		pick(tds.index(this));
		tds.each(display);
	});

	tds.each(display);
</script>
