<meta charset=UTF-8>
<title>Perk Optimizer</title>
<link rel=stylesheet href='grim.css'>
<style>
body { font-size: 1.1em }
label { display: block; margin: 1ex .25em }
input, select, textarea { width: 50%; margin: 0 }

#advanced:not(:target) ~ a, #advanced:not(:target) ~ label, #advanced:target { display: none }
#perks { width: 50rem; align-self: center; justify-content: center }
.perk { border: 2px solid black; margin: -1px }
.perk { flex: 0 0 20%; text-align: center; padding: 0.5ex 0; color: white }
.perk { background-color: #666 }
.perk.tier2 { background-color: #809080 }
.perk.capped { background-color: #696980 }
</style>

<h1>Perk Optimizer</h1>

<p id=alert class=alert>&nbsp;</p>

<form class=flexbox action='javascript://0'>
	<fieldset>
		<legend>Inputs</legend>

		<label title='Export your Trimps save and paste it here'>
			<textarea id=save onfocus='this.value = ""' onpaste='handle_paste(event)'></textarea>
			Import save
		</label>

		<label title='Total Helium Earned, as displayed on the Stats screen'>
			<input type=text id=helium required>
			Total Helium
		</label>

		<label title='Check this when respeccing from the View Perks screen'>
			<input type=checkbox id=respec>
			Mid-run respec
		</label>

		<label title='The zone on which you plan to do your Void Maps'>
			<input type=text id=zone onchange='set_zone()' required pattern='\d{2,3}'>
			VM zone
		</label>

		<label title='How much you value +1% Helium income'>
			<input type=text id=weight-he value=7>
			Weight: Helium
		</label>

		<label title='How much you value +1% attack'>
			<input type=text id=weight-atk value=3>
			Weight: Attack
		</label>

		<label title='How much you value +1% survivability (health and block)'>
			<input type=text id=weight-hp value=1>
			Weight: Health
		</label>

		<label title='How much you value +1% overkill damage'>
			<input type=text id=weight-ok value=1>
			Weight: Overkill
		</label>

		<label title='How much you value +1% breeding speed. When set to 0, breed speed is converted into health using geneticists.'>
			<input type=text id=weight-breed value=0>
			Weight: Breed
		</label>

		<a id=advanced class=centered href='#advanced'>Advanced options (you probably shouldn’t bother)</a>
		<a class=centered href='#'>Hide advanced options</a>

		<label title='The most expensive prestige you unlock before portalling'>
			<select id=climb>
				<option value=dagger>Dagger</option>
				<option value=boots>Boots</option>
				<option value=mace>Mace</option>
				<option value=helm>Helm</option>
				<option value=pole>Polearm</option>
				<option value=pants>Pants</option>
				<option value=axe>Battleaxe</option>
				<option value=guards>Shoulderguars</option>
				<option value=sword>Greatsword</option>
				<option value=plate>Breastplate</option>
				<option value=arbalest>Arbalest</option>
				<option selected value=gambeson>Gambeson</option>
			</select>
			-climbing
		</label>

		<label title='A comma-separated list of perks you have unlocked'>
			<input type=text id=unlocks required>
			Unlocked perks
		</label>

		<label title='Uncheck this if you didn’t unlock the Whipimp'>
			<input type=checkbox checked id=whipimp>
			Whipimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Magnimp'>
			<input type=checkbox checked id=magnimp>
			Magnimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Tauntimp'>
			<input type=checkbox checked id=tauntimp>
			Tauntimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Venimp'>
			<input type=checkbox checked id=venimp>
			Venimp
		</label>

		<label title='Multiplier for Chronoimp/Jestimp loot.
Set to 0 if you haven’t unlocked these imps, 2 for Chrono, 3 for Jest or 5 for both.'>
			<input type=text id=chronojest value=5>
			Chrono/Jest
		</label>

		<label title='Multiplier for all non-Helium loot.
This should only account for low map level penalty, scrying, golden maps and challenges.
The other modifiers are handled by the code.'>
			<input type=text id=loot value='1'>
			Loot multiplier
		</label>

		<label title='Fraction of farm time spent with an active turkimp.
0 = never, 1 = always, 1.5 = always + Turkimp Tamer III.'>
			<input type=text id=turkimp value='0.5'>
			Turkimp
		</label>

		<label title='Your usual breed timer'>
			<input type=text id=breed-timer value=30>
			Breed timer
		</label>

		<label title='Average number of coordinations you get from a gigastation'>
			<input type=text id=giga value=1>
			Coords per giga
		</label>

		<label title='Used in max pop calculations.
Increasing this reduces the importance of Carp, Resourceful and Trumps.'>
			<input type=text id=housing value=3>
			Housing thingy
		</label>

		<button onclick='display(optimize(parse_inputs()))'>Optimize!</button>
	</fieldset>

	<div id=perks class=flexbox></div>
</form>

<nav class=flexbox>
	<a href='zfarm.html'>zFarm</a>
	<a href='perks.html' class=active>Perks</a>
	<span class=filler></span>
	<a href='https://github.com/Grimy/Grimy.github.io/issues/new'>Report a bug</a>
	<a href='https://github.com/Grimy/Grimy.github.io/blob/master/perks.js'>View the source</a>
	<a href='https://github.com/Grimy'>By Grimy</a>
</nav>

<script src=lz-string.js></script>
<script src=trimps.js></script>
<script src=perks.js></script>
<script>

var old_perks;

function input(id) {
	return parse_suffixes($('#' + id).value.toLowerCase());
}

function set_zone() {
	var zone = parseInt($('#zone').value);
 	$('#weight-ok').parentNode.style.display = zone > 160 ? '' : 'none';
	$('#giga').parentNode.style.display = zone > 60 ? '' : 'none';
	$('#post-spire').style.display = zone > 200 ? '' : 'none';
	$('#weight-breed').value = zone > 70 ? 0 : 1;
}

function read_save(game) {
	let he_left = game.global.heliumLeftover;
	for (let perk in game.portal)
		he_left += game.portal[perk].heliumSpent;
	if (!$('#respec').checked)
		he_left += game.resources.helium.owned;

	$('#helium').value = he_left;
	$('#zone').value = game.stats.highestVoidMap.valueTotal || game.global.highestLevelCleared;
	$('#unlocks').value = Object.keys(game.portal).filter((perk) => !game.portal[perk].locked).join(',')
	$('#whipimp').checked = game.unlocks.imps.Whipimp;
	$('#magnimp').checked = game.unlocks.imps.Magnimp;
	$('#tauntimp').checked = game.unlocks.imps.Tauntimp;
	$('#venimp').checked = game.unlocks.imps.Venimp;
	$('#chronojest').value = 3 * game.unlocks.imps.Jestimp + 2 * game.unlocks.imps.Chronoimp;
	old_perks = game.portal;
}

function handle_paste(ev) {
	let game = JSON.parse(LZString.decompressFromBase64(ev.clipboardData.getData("text/plain")));
	if (game) {
		$('#alert').classList = 'ok';
		$('#alert').textContent = 'Save loaded successfully!';
		read_save(game);
		display(optimize(parse_inputs()));
	} else {
		$('#alert').classList = 'ko';
		$('#alert').textContent = 'Your clipboard did not contain a valid Trimps save. Open the game, click “Export” then “Copy to Clipboard”, and try again.';
	}
}

// TODO add checkboxes for Use Geneticist, Slow Done, Frugal Done, Sci V done
const parse_inputs = () => ({
	he_left: input('helium'),
	zone: parseInt($('#zone').value),
	unlocks: $('#unlocks').value.split(','),
	climb: $('#climb').value,
	weight: {
		helium: input('weight-he'),
		attack: input('weight-atk'),
		health: input('weight-hp'),
		overkill: input('weight-ok'),
		breed: input('weight-breed'),
	},
	mod: {
		storage: 0.02,
		whip: $('#whipimp').checked,
		magn: $('#magnimp').checked,
		taunt: $('#tauntimp').checked,
		ven: $('#venimp').checked,
		chronojest: input('chronojest'),
		loot: input('loot'),
		turkimp: input('turkimp'),
		breed_timer: input('breed-timer'),
		giga: input('giga'),
		housing: input('housing'),
	}
});

function display(level) {
	$('#perks').innerHTML = '';
	if (!level)
		return;
	for (var perk of $('#unlocks').value.split(',')) {
		var capped = level[perk] == cap[perk] ? ' capped' : '';
		var tier2 = increment[perk] ? ' tier2' : '';
		var name = perk.replace(/_/g, ' ');
		var diff = level[perk] - old_perks[perk].level;
		var diff_text = diff == 0 ? '' : diff > 0 ? ` (+${diff})` : ` (${diff})`;
		$('#perks').innerHTML +=
			`<div class='perk${capped}${tier2}'>${name}<br>${level[perk]}${diff_text}</div>`;
	}
}

</script>
