<!DOCTYPE html>
<meta charset=UTF-8>
<title>Perky</title>
<link href=blue.css rel=stylesheet>
<link href=dark.css rel=stylesheet id=dark>
<style>
#advanced { margin-bottom: 1ex }
#advanced:not(:target) ~ a, #advanced:not(:target) ~ label, #advanced:target { display: none }
#results { width: 50rem; align-self: center; justify-content: center }
.perk { border: 2px solid black; margin: -1px }
.perk { flex: 0 0 20%; text-align: center; padding: 0.5ex 0; color: white }
.perk { background-color: #666 }
.perk.capped { background-color: #696980 }
.perk.adding { background-color: #809080 }
.perk.remove { background-color: #806969 }
</style>

<h1>Perk Optimizer</h1>

<p id=alert />

<form class=flexbox action='javascript:try_wrap(() =&gt; display(optimize(parse_inputs())))'>
	<fieldset class=box>
		<legend>Inputs</legend>

		<label title='Export your Trimps save and paste it here.'>
			<textarea id=save onfocus='this.value = ""' onpaste='handle_paste(event)'></textarea>
			Import save
		</label>

		<label title='Check this when respeccing from the View Perks screen.'>
			<input type=checkbox onchange='handle_respec()' id=respec>
			Mid-run respec
		</label>

		<label title='The base zone used in calculations. Set this to a few zone before your planned portalling zone, for example the zone on which you do your Void Maps.'>
			<input type=text id=zone onchange='set_zone(this.value)' required pattern='\d{2,3}'>
			Target zone
		</label>

		<label title='Suggested weights far various stages of the game.'>
			<select onchange='select_preset(this.value)'>
				<option>Pick one…
				<option value=early>Early game</option>
				<option value=broken>Broken planet</option>
				<option value=corruption>Corruption</option>
				<option value=spire>Spire</option>
				<option value=magma>Magma</option>
				<option value=z400>z400+</option>
			</select>
			Presets
		</label>

		<label title='How much you value +1% Helium income.'>
			<input type=text id=weight-he value=7 oninput='check_input(this)' data-saved>
			Weight: Helium
		</label>

		<label title='How much you value +1% attack.'>
			<input type=text id=weight-atk value=3 oninput='check_input(this)' data-saved>
			Weight: Attack
		</label>

		<label title='How much you value +1% survivability (health and block).'>
			<input type=text id=weight-hp value=1 oninput='check_input(this)' data-saved>
			Weight: Health
		</label>

		<label title='How much you value +1% overkill damage.'>
			<input type=text id=weight-ok value=1 oninput='check_input(this)' data-saved>
			Weight: Overkill
		</label>

		<label title='A list of perks that you don’t want to change, for example “power=42, carp=31”'>
			<input type=text id=fixed oninput='validate_fixed()' data-saved>
			Fixed perks
		</label>

		<a id=advanced class=centered href='#advanced'>Manual input (auto-filled when pasting a save)</a>
		<a class=centered href='#'>Hide manual input</a>

		<label title='Total Helium Earned, as displayed on the Stats screen'>
			<input type=text id=helium required oninput='check_input(this)'>
			Total Helium
		</label>

		<label title='Number of trimps generated by your DG (before carpentry)'>
			<input type=text id=dg value=0 oninput='check_input(this)'>
			DG housing
		</label>

		<label title='The most expensive prestige you unlock before portalling'>
			<select id=climb>
				<option value=dagger>Dagger</option>
				<option value=boots>Boots</option>
				<option value=mace>Mace</option>
				<option value=helm>Helm</option>
				<option value=pole>Polearm</option>
				<option value=pants>Pants</option>
				<option value=axe>Battleaxe</option>
				<option value=guards>Shoulderguars</option>
				<option value=sword>Greatsword</option>
				<option value=plate>Breastplate</option>
				<option value=arbalest>Arbalest</option>
				<option selected value=gambeson>Gambeson</option>
			</select>
			-climbing
		</label>

		<label title='A comma-separated list of perks you have unlocked'>
			<input type=text id=unlocks value='Agility,Bait,Trumps,Pheromones,Packrat,Motivation,Power,Toughness,Looting'>
			Unlocked perks
		</label>

		<label title='Uncheck this if you didn’t unlock the Whipimp'>
			<input type=checkbox checked id=whipimp>
			Whipimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Magnimp'>
			<input type=checkbox checked id=magnimp>
			Magnimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Tauntimp'>
			<input type=checkbox checked id=tauntimp>
			Tauntimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Venimp'>
			<input type=checkbox checked id=venimp>
			Venimp
		</label>

		<label title='Multiplier for Chronoimp/Jestimp loot.
Set to 0 if you haven’t unlocked these imps, 2 for Chrono, 3 for Jest or 5 for both.'>
			<input type=text id=chronojest value=5 pattern='\d+'>
			Chrono/Jest
		</label>

		<label title='Multiplier for production'>
			<input type=text id=prod value=1>
			Production mod
		</label>

		<label title='Multiplier for regular loot'>
			<input type=text id=loot value=1>
			Loot mod
		</label>

		<label title='Your usual breed timer'>
			<input type=text id=breed-timer value=30 pattern='\d+'>
			Breed timer
		</label>

		<button class=centered>Optimize!</button>
	</fieldset>

	<div id=results class=flexbox></div>
</form>

<nav class=flexbox>
	<a href=zfarm.html>zFarm</a>
	<a href=perks.html class=active>Perky</a>
	<span class=filler></span>
	<a onclick='switch_theme()'>Switch theme</a>
	<a href=changelog.html>Changelog</a>
	<a href='https://github.com/Grimy/Grimy.github.io/issues/new'>Report a bug</a>
	<a href='https://github.com/Grimy/Grimy.github.io/blob/master/perks.js'>View the source</a>
	<a href='https://github.com/Grimy'>By Grimy</a>
</nav>

<script src=lz-string.js></script>
<script src=trimps.js></script>
<script src=perks.js></script>
<script>
"use strict";

var old_game;
var helium = {base: 0, owned: 0};

function parse_fixed(value) {
	if (!value)
		return {};
	var fixed = {}

	for (var item of value.split(/ *, */)) {
		if (!item.match(/=/))
			return 'Please enter a list of perk levels, such as “power=42, toughness=51”';
		var [name, value] = item.split(/ *= */);

		var perk = name.toLowerCase().replace(/[a-z]/, l => l.toUpperCase());
		var tier2 = perk.endsWith('2') || perk.endsWith('ii');
		perk = perk.replace(/[ _]?(2|II)/i, '').replace('Ok', 'O').replace('Looty', 'L');
		perk = perks.filter(p => p.endsWith('_II') == tier2 && p.startsWith(perk));

		if (!perk)
			return `Unknown perk: ${name}.`;
		if (perk.length > 1)
			return `Ambiguous perk abbreviation: ${name}`;

		var level = parse_suffixes(value);
		if (level === null)
			return `Invalid number: ${value}.`;

		fixed[perk[0]] = level;
	}

	return fixed;
}

function validate_fixed() {
	var result = parse_fixed($('#fixed').value);
	$('#fixed').setCustomValidity(typeof result == 'string' ? result : '');
}

validate_fixed();

function set_zone(zone) {
	$('#zone').value = zone;
	$('#weight-ok').parentNode.style.display = zone > 160 ? '' : 'none';
	$('#dg').value = old_game ? generated_housing(old_game, zone / 2 + 115) : 0;
}

function spire_preset() {
	set_zone(200);
	$('#prod').value = 0;
	$('#loot').value = 0;
}

function select_preset(name) {
	var preset = {
		early: [5, 4, 2, 0],
		broken: [7, 3, 1, 1],
		corruption: [25, 7, 1, 2],
		spire: [0, 1, 1, 0],
		magma: [35, 4, 3, 1],
		z400: [69, 7, 1, 4],
	}[name];

	if (name == 'spire')
		spire_preset();

	$('#weight-he').value = preset[0];
	$('#weight-atk').value = preset[1];
	$('#weight-hp').value = preset[2];
	$('#weight-ok').value = preset[3];
}

function input(id) {
	return parse_suffixes($('#' + id).value);
}

function handle_respec() {
	$('#helium').value = helium.base + ($('#respec').checked ? 0 : helium.owned);
}

function generated_housing(game, max_zone) {
	var eff = 500e6 + 50e6 * game.generatorUpgrades.Efficiency.upgrades;
	var capa = 3 + 0.4 * game.generatorUpgrades.Capacity.upgrades;
	var max_fuel = game.permanentGeneratorUpgrades.Storage.owned ? capa * 1.5 : capa;
	var supply = 230 + 2 * game.generatorUpgrades.Supply.upgrades;
	var overclock = game.generatorUpgrades.Overclocker.upgrades;
	overclock = overclock && (1 - 0.5 * pow(0.99, overclock - 1));
	var burn = game.permanentGeneratorUpgrades.Slowburn.owned ? 0.4 : 0.5;
	var cells = game.talents.magmaFlow ? 18 : 16;
	var accel = game.talents.quickGen ? 1.03 : 1.02;
	var speed = game.talents.hyperspeed ? 20 : 25;
	var hs2 = game.talents.hyperspeed2 ? (game.global.highestLevelCleared + 1) / 2 : 0;
	var bs = 0.5*game.talents.blacksmith + 0.25*game.talents.blacksmith2 + 0.15*game.talents.blacksmith3;
	bs *= game.global.highestLevelCleared + 1;
	var housing = 0;
	var fuel = 0;
	var time = 0;

	function tick(mult) {
		housing += mult * eff * sqrt(min(capa, fuel));
		fuel -= burn;
	}

	for (var zone = 230; zone <= max_zone; ++zone) {
		fuel += cells * (0.01 * min(zone, supply) - 2.1);

		var tick_time = ceil(60 / pow(accel, floor((zone - 230) / 3)));
		time += zone > bs ? 28 : zone > hs2 ? 20 : 15;
		while (time >= tick_time) {
			time -= tick_time;
			tick(1);
		}

		while (fuel > max_fuel)
			tick(overclock)

		housing *= 1.009;
	}

	while (fuel >= burn)
		tick(1);
	return floor(housing);
}

function read_save(game) {
	old_game = game;

	helium.base = game.global.heliumLeftover;
	for (var perk in game.portal)
		helium.base += game.portal[perk].heliumSpent;
	helium.owned = game.resources.helium.owned;
	handle_respec();

	var tt = game.talents.turkimp4 ? 1 :
	         game.talents.turkimp3 ? 0.6 :
	         game.talents.turkimp2 ? 0.4 :
	         game.talents.turkimp ? 0.3 : 0.25;
	var prod = 1 + tt;
	var loot = 1 + (tt / 3);

	for (var mod of (game.global.StaffEquipped.mods || [])) {
		if (mod[0] == 'MinerSpeed')
			prod *= 1 + 0.01 * mod[1];
		else if (mod[0] == 'metalDrop')
			loot *= 1 + 0.01 * mod[1];
	}

	if (!$('#zone').value || game.global.highestLevelCleared < 400)
		set_zone(game.global.highestLevelCleared - 5);

	$(`#climb > [value=${game.global.slowDone ? 'gambeson' : 'plate'}]`).selected = true;
	$('#unlocks').value = Object.keys(game.portal).filter((perk) => !game.portal[perk].locked).join(',')
	$('#whipimp').checked = game.unlocks.imps.Whipimp;
	$('#magnimp').checked = game.unlocks.imps.Magnimp;
	$('#tauntimp').checked = game.unlocks.imps.Tauntimp;
	$('#venimp').checked = game.unlocks.imps.Venimp;
	$('#chronojest').value = 3 * game.unlocks.imps.Jestimp + 2 * game.unlocks.imps.Chronoimp;
	$('#prod').value = prod;
	$('#loot').value = loot;
	$('#breed-timer').value = game.talents.patience ? 45 : 30;

	if ($('[value=spire]').selected)
		spire_preset();
}

var parse_inputs = () => ({
	he_left: input('helium'),
	zone: parseInt($('#zone').value),
	unlocks: $('#unlocks').value.split(','),
	fixed: parse_fixed($('#fixed').value),
	climb: $('#climb').value,
	weight: {
		helium: input('weight-he'),
		attack: input('weight-atk'),
		health: input('weight-hp'),
		overkill: input('weight-ok'),
	},
	mod: {
		storage: 0.125,
		dg: input('dg'),
		whip: $('#whipimp').checked,
		magn: $('#magnimp').checked,
		taunt: $('#tauntimp').checked,
		ven: $('#venimp').checked,
		chronojest: input('chronojest'),
		prod: input('prod'),
		loot: input('loot'),
		breed_timer: input('breed-timer'),
	}
});

function display(level) {
	$('#results').innerHTML = '';
	if (!level)
		return;
	for (var perk of $('#unlocks').value.split(',')) {
		var capped = level[perk] == cap[perk] ? ' capped' : '';
		var name = perk.replace('_', ' ');
		var diff = old_game ? level[perk] - old_game.portal[perk].level : 0;
		var diff_text = diff ? ` (${diff > 0 ? '+' : '-'}${prettify(abs(diff))})` : '';
		var adding = diff > 0 ? ' adding' : '';
		var remove = diff < 0 ? ' remove' : '';
		$('#results').innerHTML += `<div class='perk${capped}${adding}${remove}'>`
			+ `${name}<br>Level: ${prettify(level[perk])}${diff_text}</div>`;
	}
}

</script>
